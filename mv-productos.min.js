(function(){"use strict";var scripts=document.getElementsByTagName("script");var currentScriptPath=scripts[scripts.length-1].src;if(currentScriptPath.length==0){currentScriptPath=window.installPath+"/ac-angular-productos/includes/mv-productos.php"}angular.module("acProductos",[]).factory("ProductService",ProductService).service("ProductVars",ProductVars).factory("CategoryService",CategoryService).service("CategoryVars",CategoryVars).factory("CartService",CartService).service("CartVars",CartVars);ProductService.$inject=["$http","ProductVars","$cacheFactory","AcUtils"];function ProductService($http,ProductVars,$cacheFactory,AcUtils){var service={};var url=currentScriptPath.replace("mv-productos.js","/includes/mv-productos.php");service.get=get;service.getByParams=getByParams;service.getMasVendidos=getMasVendidos;service.getByCategoria=getByCategoria;service.create=create;service.update=update;service.remove=remove;service.goToPagina=goToPagina;service.next=next;service.prev=prev;return service;function get(callback){var urlGet=url+"?function=getProductos";var $httpDefaultCache=$cacheFactory.get("$http");var cachedData=[];if($httpDefaultCache.get(urlGet)!=undefined){if(ProductVars.clearCache){$httpDefaultCache.remove(urlGet)}else{cachedData=$httpDefaultCache.get(urlGet);callback(cachedData);return}}return $http.get(urlGet,{cache:true}).success(function(data){$httpDefaultCache.put(urlGet,data);ProductVars.clearCache=false;ProductVars.paginas=data.length%ProductVars.paginacion==0?parseInt(data.length/ProductVars.paginacion):parseInt(data.length/ProductVars.paginacion)+1;callback(data)}).error(function(data){callback(data);ProductVars.clearCache=false})}function getByParams(params,values,exact_match,callback){get(function(data){AcUtils.getByParams(params,values,exact_match,data,callback)})}function getMasVendidos(callback){get(function(data){var response=data.sort(function(a,b){return b.vendidos-a.vendidos});callback(response.slice(0,8))})}function getByCategoria(categoria_id,callback){var productos=[];get(function(data){if(data==undefined||data.length==0)return callback(productos);data.forEach(function(producto){if(producto===undefined||producto.categorias===undefined||producto.categorias.length==0)return callback(productos);if(categoria_id==producto.categorias[0].categoria_id)productos.push(producto)});return callback(productos)})}function remove(producto_id,callback){return $http.post(url,{"function":"removeProducto",producto_id:producto_id}).success(function(data){if(data!=="false"){ProductVars.clearCache=true;callback(data)}}).error(function(data){callback(data)})}function create(producto,callback){return $http.post(url,{"function":"createProducto",producto:JSON.stringify(producto)}).success(function(data){ProductVars.clearCache=true;callback(data)}).error(function(data){ProductVars.clearCache=true;callback(data)})}function update(producto,callback){return $http.post(url,{"function":"updateProducto",producto:JSON.stringify(producto)}).success(function(data){ProductVars.clearCache=true;callback(data)}).error(function(data){callback(data)})}function goToPagina(pagina){if(isNaN(pagina)||pagina<1){ProductVars.pagina=1;return ProductVars}if(pagina>ProductVars.paginas){ProductVars.pagina=ProductVars.paginas;return ProductVars}ProductVars.pagina=pagina-1;ProductVars.start=ProductVars.pagina*ProductVars.paginacion;return ProductVars}function next(){if(ProductVars.pagina+1>ProductVars.paginas){return ProductVars}ProductVars.start=ProductVars.pagina*ProductVars.paginacion;ProductVars.pagina=ProductVars.pagina+1;return ProductVars}function prev(){if(ProductVars.pagina-2<0){return ProductVars}ProductVars.start=(ProductVars.pagina-2)*ProductVars.paginacion;ProductVars.pagina=ProductVars.pagina-1;return ProductVars}}ProductVars.$inject=[];function ProductVars(){this.paginas=1;this.pagina=1;this.paginacion=10;this.start=0;this.clearCache=true}CategoryService.$inject=["$http","CategoryVars","$cacheFactory","AcUtils"];function CategoryService($http,CategoryVars,$cacheFactory,AcUtils){var service={};var url=currentScriptPath.replace("mv-productos.js","/includes/mv-productos.php");service.get=get;service.getByParams=getByParams;service.create=create;service.update=update;service.remove=remove;service.goToPagina=goToPagina;service.next=next;service.prev=prev;return service;function get(callback){var urlGet=url+"?function=getCategorias";var $httpDefaultCache=$cacheFactory.get("$http");var cachedData=[];if($httpDefaultCache.get(urlGet)!=undefined){if(CategoryVars.clearCache){$httpDefaultCache.remove(urlGet)}else{cachedData=$httpDefaultCache.get(urlGet);callback(cachedData);return}}return $http.get(urlGet,{cache:true}).success(function(data){$httpDefaultCache.put(urlGet,data);CategoryVars.clearCache=false;CategoryVars.paginas=data.length%CategoryVars.paginacion==0?parseInt(data.length/CategoryVars.paginacion):parseInt(data.length/CategoryVars.paginacion)+1;callback(data)}).error(function(data){callback(data);CategoryVars.clearCache=false})}function getByParams(params,values,exact_match,callback){get(function(data){AcUtils.getByParams(params,values,exact_match,data,callback)})}function remove(categoria_id,callback){return $http.post(url,{"function":"removeCategoria",categoria_id:categoria_id}).success(function(data){if(data!=="false"){CategoryVars.clearCache=true;callback(data)}}).error(function(data){callback(data)})}function create(categoria,callback){return $http.post(url,{"function":"createCategoria",categoria:JSON.stringify(categoria)}).success(function(data){CategoryVars.clearCache=true;callback(data)}).error(function(data){CategoryVars.clearCache=true;callback(data)})}function update(categoria,callback){return $http.post(url,{"function":"updateCategoria",categoria:JSON.stringify(categoria)}).success(function(data){CategoryVars.clearCache=true;callback(data)}).error(function(data){callback(data)})}function goToPagina(pagina){if(isNaN(pagina)||pagina<1){CategoryVars.pagina=1;return CategoryVars}if(pagina>CategoryVars.paginas){CategoryVars.pagina=CategoryVars.paginas;return CategoryVars}CategoryVars.pagina=pagina-1;CategoryVars.start=CategoryVars.pagina*CategoryVars.paginacion;return CategoryVars}function next(){if(CategoryVars.pagina+1>CategoryVars.paginas){return CategoryVars}CategoryVars.start=CategoryVars.pagina*CategoryVars.paginacion;CategoryVars.pagina=CategoryVars.pagina+1;return CategoryVars}function prev(){if(CategoryVars.pagina-2<0){return CategoryVars}CategoryVars.start=(CategoryVars.pagina-2)*CategoryVars.paginacion;CategoryVars.pagina=CategoryVars.pagina-1;return CategoryVars}}CategoryVars.$inject=[];function CategoryVars(){this.paginas=1;this.pagina=1;this.paginacion=10;this.start=0;this.clearCache=true}CartService.$inject=["$http","CartVars","$cacheFactory","AcUtils"];function CartService($http,CartVars,$cacheFactory,AcUtils){var service={};var url=currentScriptPath.replace("mv-productos.js","/includes/mv-productos.php");service.get=get;service.getByParams=getByParams;service.create=create;service.update=update;service.remove=remove;service.addToCart=addToCart;service.updateProductInCart=updateProductInCart;service.removeFromCart=removeFromCart;service.reloadLastCart=reloadLastCart;service.checkOut=checkOut;service.goToPagina=goToPagina;service.next=next;service.prev=prev;return service;function addToCart(carrito_id,producto,callback){return $http.post(url,{"function":"createCarritoDetalle",carrito_id:carrito_id,carrito_detalle:JSON.stringify(producto)}).success(function(data){if(data!=-1){for(var i=0;i<data.length;i++){CartVars.carrito.push(data[i])}CartVars.broadcast()}CartVars.clearCache=true;callback(data)}).error(function(data){CartVars.clearCache=true;callback(data)})}function updateProductInCart(carrito_detalle,callback){return $http.post(url,{"function":"updateCarritoDetalle",carrito_detalle:JSON.stringify(carrito_detalle)}).success(function(data){if(data!=-1){var index=0;for(var i=0;i<CartVars.carrito.length;i++){if(CartVars.carrito[i].carrito_detalle_id==carrito_detalle.carrito_detalle_id){index=i}}CartVars.carrito[index]={};CartVars.carrito[index]=carrito_detalle;CartVars.broadcast()}CartVars.clearCache=true;callback(data)}).error(function(data){CartVars.clearCache=true;callback(data)})}function removeFromCart(carrito_detalle_id,callback){return $http.post(url,{"function":"removeCarritoDetalle",carrito_detalle_id:JSON.stringify(carrito_detalle_id)}).success(function(data){if(data!=-1){var index=0;for(var i=0;i<CartVars.carrito.length;i++){if(CartVars.carrito[i].carrito_detalle_id==carrito_detalle_id){index=i}}CartVars.carrito.splice(index,1);CartVars.broadcast()}CartVars.clearCache=true;callback(data)}).error(function(data){CartVars.clearCache=true;callback(data)})}function reloadLastCart(usuario_id,callback){get(usuario_id,function(data){AcUtils.getByParams("status","0","true",data,callback)})}function checkOut(carrito_id,callback){update({carrito_id:carrito_id,status:1},function(data){callback(data)})}function get(usuario_id,callback){var urlGet=url+"?function=getCarritos&usuario_id="+usuario_id;var $httpDefaultCache=$cacheFactory.get("$http");var cachedData=[];if($httpDefaultCache.get(urlGet)!=undefined){if(CartVars.clearCache){$httpDefaultCache.remove(urlGet)}else{cachedData=$httpDefaultCache.get(urlGet);callback(cachedData);return}}return $http.get(urlGet,{cache:true}).success(function(data){$httpDefaultCache.put(urlGet+usuario_id,data);CartVars.clearCache=false;CartVars.paginas=data.length%CartVars.paginacion==0?parseInt(data.length/CartVars.paginacion):parseInt(data.length/CartVars.paginacion)+1;callback(data)}).error(function(data){callback(data);CartVars.clearCache=false})}function getByParams(params,values,exact_match,usuario_id,callback){get(usuario_id,function(data){AcUtils.getByParams(params,values,exact_match,data,callback)})}function remove(carrito_id,callback){return $http.post(url,{"function":"removeCarrito",carrito_id:carrito_id}).success(function(data){if(data!=="false"){CartVars.clearCache=true;callback(data)}}).error(function(data){callback(data)})}function create(carrito,callback){return $http.post(url,{"function":"createCarrito",carrito:JSON.stringify(carrito)}).success(function(data){CartVars.clearCache=true;callback(data)}).error(function(data){CartVars.clearCache=true;callback(data)})}function update(carrito,callback){return $http.post(url,{"function":"updateCarrito",carrito:JSON.stringify(carrito)}).success(function(data){CartVars.clearCache=true;callback(data)}).error(function(data){callback(data)})}function goToPagina(pagina){if(isNaN(pagina)||pagina<1){CartVars.pagina=1;return CartVars}if(pagina>CartVars.paginas){CartVars.pagina=CartVars.paginas;return CartVars}CartVars.pagina=pagina-1;CartVars.start=CartVars.pagina*CartVars.paginacion;return CartVars}function next(){if(CartVars.pagina+1>CartVars.paginas){return CartVars}CartVars.start=CartVars.pagina*CartVars.paginacion;CartVars.pagina=CartVars.pagina+1;return CartVars}function prev(){if(CartVars.pagina-2<0){return CartVars}CartVars.start=(CartVars.pagina-2)*CartVars.paginacion;CartVars.pagina=CartVars.pagina-1;return CartVars}}CartVars.$inject=["$rootScope"];function CartVars($rootScope){this.paginas=1;this.pagina=1;this.paginacion=10;this.start=0;this.carrito=[];this.carrito_cantidad_productos=function(){var cantidad=0;for(var i=0;i<this.carrito.length;i++){cantidad=cantidad+this.carrito[i].cantidad}return cantidad};this.carrito_total=function(){var precio=0;for(var i=0;i<this.carrito.length;i++){precio=precio+this.carrito[i].cantidad*this.carrito[i].precio_unitario}return precio};this.clearCache=true;this.broadcast=function(){$rootScope.$broadcast("CartVars")};this.listen=function(callback){$rootScope.$on("CartVars",callback)}}})();